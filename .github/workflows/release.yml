name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'ç‰ˆæœ¬ tag (å¦‚ v2.2.0)'
        required: true
        type: string

jobs:
  # å„å¹³å°å¹³è¡Œæ‰“åŒ…
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            build_cmd: npx electron-builder --win portable nsis --publish never
            artifact_pattern: |
              dist/TermLauncher-Portable.exe
              dist/TermLauncher Setup *.exe
            artifact_name: windows
          - os: macos-latest
            build_cmd: npx electron-builder --mac --publish never
            artifact_pattern: |
              dist/*.dmg
            artifact_name: macos
          - os: ubuntu-latest
            build_cmd: npx electron-builder --linux --publish never
            artifact_pattern: |
              dist/*.AppImage
            artifact_name: linux

    runs-on: ${{ matrix.os }}
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache electron-builder (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\electron\Cache
            ~\AppData\Local\electron-builder\Cache
          key: electron-builder-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            electron-builder-${{ runner.os }}-

      - name: Cache electron-builder (macOS)
        if: runner.os == 'macOS'
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
          key: electron-builder-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            electron-builder-${{ runner.os }}-

      - name: Cache electron-builder (Linux)
        if: runner.os == 'Linux'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: electron-builder-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            electron-builder-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build
        run: ${{ matrix.build_cmd }}
        env:
          # macOS: è·³é code signingï¼ˆç„¡ Apple Developer æ†‘è­‰æ™‚éœ€è¦ï¼‰
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_pattern }}
          if-no-files-found: error

  # åˆä½µæ‰€æœ‰å¹³å°ç”¢ç‰©ï¼Œå»ºç«‹ Release
  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Extract version info
        id: version
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          VERSION="${TAG#v}"
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

          # å¾ CHANGELOG.md æå–å°æ‡‰ç‰ˆæœ¬çš„å…§å®¹
          if grep -qP "## ğŸš€ v$VERSION" docs/CHANGELOG.md; then
            TITLE=$(grep -oP "## ğŸš€ v$VERSION\s*-\s*\K[^(]+" docs/CHANGELOG.md | head -1 | xargs)
            echo "RELEASE_TITLE=ğŸš€ v$VERSION - $TITLE" >> "$GITHUB_OUTPUT"

            # æå–ç‰ˆæœ¬å€å¡Šå…§å®¹ï¼ˆå¾æ¨™é¡Œè¡Œä¹‹å¾Œåˆ°ä¸‹ä¸€å€‹ ## ğŸš€ v æˆ–æª”æ¡ˆçµå°¾ï¼‰
            DELIMITER="EOF_$(uuidgen | tr -d '-')"
            echo "RELEASE_NOTES<<$DELIMITER" >> "$GITHUB_OUTPUT"
            sed -n "/## ğŸš€ v$VERSION/,/^## ğŸš€ v/{/^## ğŸš€ v/!p}" docs/CHANGELOG.md | sed '/^$/N;/^\n$/d' >> "$GITHUB_OUTPUT"
            echo "$DELIMITER" >> "$GITHUB_OUTPUT"
          else
            echo "RELEASE_TITLE=v$VERSION" >> "$GITHUB_OUTPUT"
            echo "RELEASE_NOTES=Release v$VERSION" >> "$GITHUB_OUTPUT"
          fi
        shell: bash

      - name: Validate version consistency
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          VERSION="${TAG#v}"
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$PKG_VERSION" != "$VERSION" ]; then
            echo "::error::Version mismatch: package.json ($PKG_VERSION) != tag ($VERSION)"
            exit 1
          fi
        shell: bash

      - name: Create Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ inputs.tag || github.ref_name }}
          name: ${{ steps.version.outputs.RELEASE_TITLE }}
          body: ${{ steps.version.outputs.RELEASE_NOTES }}
          files: artifacts/*
          draft: false
          prerelease: false
