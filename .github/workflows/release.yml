name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'ç‰ˆæœ¬ tag (å¦‚ v2.2.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache electron-builder
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\electron\Cache
            ~\AppData\Local\electron-builder\Cache
          key: electron-builder-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            electron-builder-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npx electron-builder --win portable nsis --publish never

      - name: Extract version info
        id: version
        run: |
          $tag = if ("${{ inputs.tag }}") { "${{ inputs.tag }}" } else { "${{ github.ref_name }}" }
          $version = $tag -replace '^v', ''
          "VERSION=$version" >> $env:GITHUB_OUTPUT

          # å¾ CHANGELOG.md æå–å°æ‡‰ç‰ˆæœ¬çš„å…§å®¹
          $content = Get-Content docs/CHANGELOG.md -Raw -Encoding UTF8

          # æå–æ¨™é¡Œï¼ˆæ ¼å¼ï¼š## ğŸš€ vX.X.X - æ¨™é¡Œ (æ—¥æœŸ)ï¼‰
          $titlePattern = "## ğŸš€ v$version\s*-\s*([^(\r\n]+)"
          if ($content -match $titlePattern) {
            $title = $Matches[1].Trim()
            "RELEASE_TITLE=ğŸš€ v$version - $title" >> $env:GITHUB_OUTPUT
          } else {
            "RELEASE_TITLE=v$version" >> $env:GITHUB_OUTPUT
          }

          # åŒ¹é…ç‰ˆæœ¬å€å¡Šï¼ˆå¾ ## ğŸš€ vX.X.X åˆ°ä¸‹ä¸€å€‹ ## ğŸš€ v æˆ–æª”æ¡ˆçµå°¾ï¼‰
          $pattern = "(?s)## ğŸš€ v$version[^\r\n]*\r?\n(.*?)(?=\r?\n## ğŸš€ v|\z)"
          if ($content -match $pattern) {
            $notes = $Matches[1].Trim()

            # è™•ç†å¤šè¡Œè¼¸å‡º
            $delimiter = "EOF_$([guid]::NewGuid().ToString('N'))"
            "RELEASE_NOTES<<$delimiter" >> $env:GITHUB_OUTPUT
            $notes >> $env:GITHUB_OUTPUT
            $delimiter >> $env:GITHUB_OUTPUT
          } else {
            "RELEASE_NOTES=Release $tag" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ inputs.tag || github.ref_name }}
          name: ${{ steps.version.outputs.RELEASE_TITLE }}
          body: ${{ steps.version.outputs.RELEASE_NOTES }}
          files: |
            dist/TermLauncher-Portable.exe
            dist/TermLauncher Setup *.exe
          draft: false
          prerelease: false
